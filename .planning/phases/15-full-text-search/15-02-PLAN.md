---
phase: 15-full-text-search
plan: 02
type: execute
depends_on: ["15-01"]
files_modified: [packages/webapp/src/lib/api.ts, packages/webapp/src/components/SearchBar.tsx, packages/webapp/src/app/page.tsx, package.json]
---

<objective>
Add debounced search bar to webapp with URL sync.

Purpose: Enable users to search thoughts from the dashboard with instant feedback.
Output: Search bar component with 300ms debounce, URL-synced query, results displayed in main list.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
@./.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-full-text-search/15-RESEARCH.md
@.planning/phases/15-full-text-search/15-01-SUMMARY.md

**Key source files:**
@packages/webapp/src/lib/api.ts
@packages/webapp/src/app/page.tsx

**From Plan 01:**
- Search endpoint: GET /items/search?q={query}
- Returns ranked results array

**From RESEARCH.md:**
- Use use-debounce library (recommended by Next.js docs)
- 300ms debounce delay
- Sync search to URL params with router.push
- Use searchParams.get('q') for initial value
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install use-debounce and create SearchBar component</name>
  <files>package.json, packages/webapp/src/components/SearchBar.tsx</files>
  <action>
1. Install use-debounce in webapp package:
   ```bash
   pnpm --filter @mental/webapp add use-debounce
   ```

2. Create SearchBar.tsx component:
   - "use client" directive (uses hooks)
   - Accept `defaultValue` prop for initial query from URL
   - Use useDebouncedCallback from use-debounce
   - On input change, debounce 300ms then call router.push with updated URL params
   - Style consistently with existing dashboard (gray border, rounded, focus ring)

**Pattern from RESEARCH.md:**
```typescript
"use client";

import { useSearchParams, useRouter, usePathname } from "next/navigation";
import { useDebouncedCallback } from "use-debounce";

interface SearchBarProps {
  defaultValue?: string;
}

export function SearchBar({ defaultValue = "" }: SearchBarProps) {
  const searchParams = useSearchParams();
  const router = useRouter();
  const pathname = usePathname();

  const handleSearch = useDebouncedCallback((term: string) => {
    const params = new URLSearchParams(searchParams.toString());
    if (term.trim()) {
      params.set("q", term.trim());
    } else {
      params.delete("q");
    }
    router.push(`${pathname}?${params.toString()}`);
  }, 300);

  return (
    <input
      type="text"
      defaultValue={defaultValue}
      onChange={(e) => handleSearch(e.target.value)}
      placeholder="Search thoughts..."
      className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
    />
  );
}
```
  </action>
  <verify>pnpm --filter @mental/webapp build succeeds (type check passes)</verify>
  <done>SearchBar component created with debounced URL sync.</done>
</task>

<task type="auto">
  <name>Task 2: Integrate search into dashboard page</name>
  <files>packages/webapp/src/app/page.tsx, packages/webapp/src/lib/api.ts</files>
  <action>
1. Update api.ts to add search function (or use items client with search endpoint).

2. Update page.tsx:
   - Read `q` from searchParams
   - If `q` exists, call search endpoint instead of listing all items
   - Add SearchBar component above the items list
   - Pass current `q` value as defaultValue to SearchBar
   - Wrap SearchBar in Suspense (uses useSearchParams)

3. When searching:
   - If q param present: fetch from /items/search?q={q}
   - If no q param: fetch from /items (existing behavior)
   - Display "No results found" message if search returns empty

**Integration pattern:**
```typescript
// In page.tsx
import { SearchBar } from "@/components/SearchBar";
import { Suspense } from "react";

// Get search param
const q = searchParams?.q as string | undefined;

// Fetch based on whether searching
let items;
if (q && q.trim()) {
  const searchRes = await itemsClient.search.$get({ query: { q } });
  items = searchRes.ok ? await searchRes.json() : [];
} else {
  // existing items fetch logic
}

// In JSX, add search bar
<Suspense fallback={<div className="h-10" />}>
  <SearchBar defaultValue={q} />
</Suspense>
```
  </action>
  <verify>
1. pnpm --filter @mental/webapp build succeeds
2. Start webapp: pnpm --filter @mental/webapp dev
3. Visit http://localhost:3001
4. Type in search bar, URL updates after 300ms
5. Results filter based on search query
  </verify>
  <done>Search bar integrated, URL syncs, results filter on search.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Full-text search with debounced URL-synced search bar</what-built>
  <how-to-verify>
    1. Start API: pnpm --filter @mental/api dev
    2. Start webapp: pnpm --filter @mental/webapp dev
    3. Visit http://localhost:3001
    4. Verify search bar appears above items list
    5. Type a search term (e.g., "phase" or a word from your thoughts)
    6. Wait ~300ms, verify URL updates to /?q=searchterm
    7. Verify results filter to matching thoughts
    8. Clear search, verify all items return
    9. Refresh page with ?q=term in URL, verify search persists
  </how-to-verify>
  <resume-signal>Type "approved" to complete phase, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] use-debounce installed
- [ ] SearchBar component created
- [ ] `pnpm --filter @mental/webapp build` succeeds
- [ ] Search bar visible on dashboard
- [ ] Typing updates URL after debounce
- [ ] Results filter based on search query
- [ ] Human verification approved
</verification>

<success_criteria>
- SearchBar with 300ms debounce
- URL sync (bookmarkable/shareable searches)
- Results filter on search
- Clean, consistent styling
- Phase 15 complete
</success_criteria>

<output>
After completion, create `.planning/phases/15-full-text-search/15-02-SUMMARY.md`
</output>
