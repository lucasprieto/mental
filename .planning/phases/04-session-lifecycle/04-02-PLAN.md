---
phase: 04-session-lifecycle
plan: 02
type: execute
depends_on: ["04-01"]
files_modified: [packages/mcp-server/src/index.ts]
---

<objective>
Add session tracking to link captured items to coding sessions.

Purpose: Enable session-aware resolution - see what was captured in a session, resolve all at once.
Output: Session management tools (start_session, end_session, get_session).
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-session-lifecycle/04-01-SUMMARY.md

**From 04-01:**
- 6 tools including resolve_thought and reopen_thought
- Lifecycle transitions working

**Schema field for sessions:**
- sessionId: text (links item to session)

**Session concept:**
- Session = a coding session with Claude/Cursor
- Items captured during a session get sessionId
- End session shows what was captured, offers bulk resolution

**Decisions:**
- [02-01]: console.error for all logging
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add session state management</name>
  <files>packages/mcp-server/src/index.ts</files>
  <action>
Add in-memory session tracking at the top of the file (after imports):

```typescript
// Session tracking (in-memory for this process)
let currentSessionId: string | null = null;
let sessionStartTime: Date | null = null;
```

Then add start_session tool:

```typescript
server.tool(
  "start_session",
  "Start a new mental capture session. Items captured after this will be linked to the session. Use at the beginning of a focused work session.",
  {
    name: z.string().optional().describe("Optional session name/description")
  },
  async ({ name }) => {
    if (currentSessionId) {
      return {
        content: [{
          type: "text",
          text: `Session already active: ${currentSessionId}\nStarted: ${sessionStartTime?.toISOString()}\n\nEnd the current session first with end_session.`
        }]
      };
    }

    currentSessionId = createId();
    sessionStartTime = new Date();

    console.error(`[mental-mcp] Session started: ${currentSessionId}`);

    return {
      content: [{
        type: "text",
        text: `Session started: ${currentSessionId}\n${name ? `Name: ${name}\n` : ""}Time: ${sessionStartTime.toISOString()}\n\nItems captured from now will be linked to this session.`
      }]
    };
  }
);
```

Note: Session state is in-memory (per MCP server process). This is fine because:
- Sessions are short-lived (single coding session)
- MCP server restarts between Claude Code sessions anyway
  </action>
  <verify>pnpm --filter @mental/mcp-server build succeeds</verify>
  <done>start_session creates session ID and tracks state</done>
</task>

<task type="auto">
  <name>Task 2: Update capture_thought to use session</name>
  <files>packages/mcp-server/src/index.ts</files>
  <action>
Modify the capture_thought tool to include sessionId when a session is active.

Find the db.insert call in capture_thought and update it:

```typescript
await db.insert(mentalItems).values({
  id,
  title,
  content,
  tags: JSON.stringify(tags || []),
  theme,
  status: "open",
  sessionId: currentSessionId,  // Add this line
  createdAt: now,
  updatedAt: now,
});
```

Also update the log message to include session info:

```typescript
if (currentSessionId) {
  console.error(`[mental-mcp] Session: ${currentSessionId}`);
}
```

And the return text should mention session if active:

```typescript
return {
  content: [{
    type: "text",
    text: `Captured: "${title}"\nID: ${id}\nTheme: ${theme || "none"}\nTags: ${tags?.join(", ") || "none"}\nStatus: open${currentSessionId ? `\nSession: ${currentSessionId}` : ""}`
  }]
};
```
  </action>
  <verify>pnpm --filter @mental/mcp-server build succeeds</verify>
  <done>capture_thought links items to active session</done>
</task>

<task type="auto">
  <name>Task 3: Add end_session tool</name>
  <files>packages/mcp-server/src/index.ts</files>
  <action>
Add end_session tool that summarizes session and offers bulk resolution:

```typescript
server.tool(
  "end_session",
  "End the current capture session. Shows summary of items captured during the session.",
  {},
  async () => {
    if (!currentSessionId) {
      return {
        content: [{
          type: "text",
          text: "No active session. Start one with start_session."
        }]
      };
    }

    const db = getDatabase();
    const sessionId = currentSessionId;
    const startTime = sessionStartTime;

    // Get items from this session
    const items = await db.select()
      .from(mentalItems)
      .where(eq(mentalItems.sessionId, sessionId))
      .orderBy(desc(mentalItems.createdAt));

    // Clear session state
    currentSessionId = null;
    sessionStartTime = null;

    console.error(`[mental-mcp] Session ended: ${sessionId}`);

    if (items.length === 0) {
      return {
        content: [{
          type: "text",
          text: `Session ended: ${sessionId}\nStarted: ${startTime?.toISOString()}\nEnded: ${new Date().toISOString()}\n\nNo items were captured during this session.`
        }]
      };
    }

    const openItems = items.filter(i => i.status === "open");
    const resolvedItems = items.filter(i => i.status === "resolved");

    const itemList = items.map(item => {
      return `- [${item.status.toUpperCase()}] ${item.title} (${item.id})`;
    }).join("\n");

    return {
      content: [{
        type: "text",
        text: `Session ended: ${sessionId}\nStarted: ${startTime?.toISOString()}\nEnded: ${new Date().toISOString()}\n\n## Items Captured: ${items.length}\n- Open: ${openItems.length}\n- Resolved: ${resolvedItems.length}\n\n${itemList}${openItems.length > 0 ? "\n\nUse resolve_thought to mark items as resolved." : ""}`
      }]
    };
  }
);
```
  </action>
  <verify>pnpm --filter @mental/mcp-server build succeeds</verify>
  <done>end_session summarizes session and clears state</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] pnpm -r build succeeds
- [ ] start_session creates new session
- [ ] capture_thought includes sessionId when session active
- [ ] end_session summarizes and clears session
- [ ] No console.log statements
- [ ] 8 tools total (ping, capture_thought, list_thoughts, get_thought, resolve_thought, reopen_thought, start_session, end_session)
</verification>

<success_criteria>
- Session lifecycle: start → capture items → end
- Items linked to session via sessionId
- end_session shows session summary
- Phase 4 complete - full session lifecycle working
</success_criteria>

<output>
After completion, create `.planning/phases/04-session-lifecycle/04-02-SUMMARY.md`
</output>
