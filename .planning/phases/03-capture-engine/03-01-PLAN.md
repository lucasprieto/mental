---
phase: 03-capture-engine
plan: 01
type: execute
depends_on: ["02-02"]
files_modified: [packages/mcp-server/package.json, packages/mcp-server/src/index.ts, packages/mcp-server/src/db.ts]
---

<objective>
Connect capture_thought tool to database with theme extraction.

Purpose: Make capture_thought actually persist data, plus auto-extract themes from content.
Output: Working capture tool that saves to SQLite with automatic theme extraction.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-mcp-server-core/02-02-SUMMARY.md

**From Phase 1:**
- @mental/db exports: getDb(), mentalItems schema, MentalItemRow types
- Tags stored as JSON string in SQLite
- Timestamps as Unix integers

**From Phase 2:**
- MCP server with capture_thought stub
- Uses console.error for logging (never console.log)
- Tool already accepts: title, content, tags

**Key files:**
@packages/mcp-server/src/index.ts
@packages/db/src/schema.ts
@packages/db/src/client.ts
@packages/shared/src/types.ts

**Decisions:**
- [01-02]: SQLite for simplicity, timestamps as integers, tags as JSON string
- [02-01]: console.error for all logging
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add database dependencies to mcp-server</name>
  <files>packages/mcp-server/package.json</files>
  <action>
Add workspace dependencies to mcp-server:

```bash
cd packages/mcp-server
pnpm add @mental/db @mental/shared @paralleldrive/cuid2
```

- @mental/db: Database client and schema
- @mental/shared: MentalItem types
- @paralleldrive/cuid2: Generate unique IDs (better than uuid for URLs)

Then run pnpm install from root to link workspace packages.
  </action>
  <verify>pnpm --filter @mental/mcp-server build succeeds; imports resolve</verify>
  <done>Dependencies added, workspace packages linked</done>
</task>

<task type="auto">
  <name>Task 2: Create database initialization module</name>
  <files>packages/mcp-server/src/db.ts</files>
  <action>
Create src/db.ts that initializes the database connection:

```typescript
import { getDb, type DbClient } from "@mental/db";
import path from "path";
import { fileURLToPath } from "url";

const __dirname = path.dirname(fileURLToPath(import.meta.url));

// Store database in the mcp-server package directory for now
// Can be made configurable via environment variable later
const DB_PATH = process.env.MENTAL_DB_PATH || path.join(__dirname, "..", "mental.db");

let db: DbClient | null = null;

export function getDatabase(): DbClient {
  if (!db) {
    console.error(`[mental-mcp] Initializing database at: ${DB_PATH}`);
    db = getDb(DB_PATH);
  }
  return db;
}
```

This ensures:
- Single database instance (singleton pattern)
- Absolute path (avoids working directory issues)
- Configurable via MENTAL_DB_PATH env var
- Logs initialization to stderr
  </action>
  <verify>pnpm --filter @mental/mcp-server build succeeds</verify>
  <done>Database module created with singleton pattern and configurable path</done>
</task>

<task type="auto">
  <name>Task 3: Implement capture_thought with persistence and theme extraction</name>
  <files>packages/mcp-server/src/index.ts</files>
  <action>
Update capture_thought tool to:

1. Import database and schema:
```typescript
import { getDatabase } from "./db.js";
import { mentalItems } from "@mental/db";
import { createId } from "@paralleldrive/cuid2";
```

2. Add simple theme extraction function:
```typescript
function extractTheme(content: string): string | null {
  // Simple keyword extraction - find most relevant topic
  // Look for patterns like "about X", "regarding X", "for X project"
  const patterns = [
    /(?:about|regarding|for|on)\s+(?:the\s+)?([a-zA-Z0-9-]+(?:\s+[a-zA-Z0-9-]+)?)/i,
    /([a-zA-Z0-9-]+)\s+(?:project|feature|issue|bug|task|ticket)/i,
  ];

  for (const pattern of patterns) {
    const match = content.match(pattern);
    if (match && match[1]) {
      return match[1].toLowerCase().trim();
    }
  }

  // Fallback: extract first significant word (skip common words)
  const stopWords = new Set(['the', 'a', 'an', 'is', 'are', 'was', 'were', 'i', 'we', 'you', 'need', 'to', 'should', 'must', 'can', 'will']);
  const words = content.toLowerCase().split(/\s+/);
  for (const word of words) {
    if (word.length > 3 && !stopWords.has(word)) {
      return word;
    }
  }

  return null;
}
```

3. Update the capture_thought handler:
```typescript
async ({ title, content, tags }) => {
  const db = getDatabase();
  const now = new Date();
  const theme = extractTheme(content);

  const id = createId();

  console.error(`[mental-mcp] Capturing: "${title}"`);
  console.error(`[mental-mcp] Theme extracted: ${theme || "none"}`);
  console.error(`[mental-mcp] Tags: ${tags?.join(", ") || "none"}`);

  await db.insert(mentalItems).values({
    id,
    title,
    content,
    tags: JSON.stringify(tags || []),
    theme,
    status: "open",
    createdAt: now,
    updatedAt: now,
  });

  console.error(`[mental-mcp] Saved with ID: ${id}`);

  return {
    content: [{
      type: "text",
      text: `Captured: "${title}"\nID: ${id}\nTheme: ${theme || "none"}\nTags: ${tags?.join(", ") || "none"}\nStatus: open`
    }]
  };
}
```

CRITICAL:
- Use console.error for ALL logging (never console.log)
- Tags must be JSON.stringify'd before insert
- Timestamps are Date objects (Drizzle handles conversion)
  </action>
  <verify>pnpm --filter @mental/mcp-server build succeeds; test with MCP Inspector - capture should create DB file and return ID</verify>
  <done>capture_thought persists to database, extracts themes, returns ID for verification</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] pnpm -r build succeeds
- [ ] MCP Inspector can call capture_thought
- [ ] Database file created at packages/mcp-server/mental.db
- [ ] Captured item has ID, theme, and correct tags
- [ ] No console.log statements in source
</verification>

<success_criteria>
- capture_thought saves to SQLite database
- Theme extracted from content automatically
- Tags stored as JSON string
- Unique ID generated for each capture
- Returns confirmation with ID, theme, tags
</success_criteria>

<output>
After completion, create `.planning/phases/03-capture-engine/03-01-SUMMARY.md`
</output>
