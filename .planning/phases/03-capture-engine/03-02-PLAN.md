---
phase: 03-capture-engine
plan: 02
type: execute
depends_on: ["03-01"]
files_modified: [packages/mcp-server/src/index.ts]
---

<objective>
Add list and query tools to complete the capture engine.

Purpose: Let users see what's been captured and retrieve specific items.
Output: list_thoughts and get_thought MCP tools.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-capture-engine/03-01-SUMMARY.md

**From 03-01:**
- capture_thought now saves to database
- Database module at src/db.ts
- Theme extraction working

**Schema reminder (from @mental/db):**
- id, title, content, tags (JSON string), theme, status, resolution, sessionId
- createdAt, updatedAt, resolvedAt (timestamps)

**Decisions:**
- [02-02]: Tool descriptions matter for LLM usage guidance
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add list_thoughts tool</name>
  <files>packages/mcp-server/src/index.ts</files>
  <action>
Add a list_thoughts tool that returns recent captured items:

```typescript
import { desc, eq } from "drizzle-orm";

server.tool(
  "list_thoughts",
  "List captured thoughts from your mental database. Returns recent items with their status. Use this to see what's been captured or find a specific thought.",
  {
    status: z.enum(["open", "resolved", "all"]).optional().describe("Filter by status (default: all)"),
    limit: z.number().min(1).max(50).optional().describe("Max items to return (default: 10)")
  },
  async ({ status, limit }) => {
    const db = getDatabase();
    const maxItems = limit || 10;

    console.error(`[mental-mcp] Listing thoughts: status=${status || "all"}, limit=${maxItems}`);

    let query = db.select().from(mentalItems);

    if (status && status !== "all") {
      query = query.where(eq(mentalItems.status, status));
    }

    const items = await query
      .orderBy(desc(mentalItems.createdAt))
      .limit(maxItems);

    if (items.length === 0) {
      return {
        content: [{
          type: "text",
          text: "No thoughts captured yet."
        }]
      };
    }

    const formatted = items.map(item => {
      const tags = JSON.parse(item.tags) as string[];
      return `- [${item.status.toUpperCase()}] ${item.title}\n  ID: ${item.id}\n  Theme: ${item.theme || "none"}\n  Tags: ${tags.join(", ") || "none"}\n  Created: ${item.createdAt.toISOString()}`;
    }).join("\n\n");

    return {
      content: [{
        type: "text",
        text: `Found ${items.length} thought(s):\n\n${formatted}`
      }]
    };
  }
);
```

CRITICAL: Use console.error for logging, parse tags from JSON string.
  </action>
  <verify>pnpm --filter @mental/mcp-server build succeeds</verify>
  <done>list_thoughts tool returns captured items with filtering</done>
</task>

<task type="auto">
  <name>Task 2: Add get_thought tool</name>
  <files>packages/mcp-server/src/index.ts</files>
  <action>
Add a get_thought tool to retrieve a specific item by ID:

```typescript
server.tool(
  "get_thought",
  "Get details of a specific thought by its ID. Use this to see full content of a captured thought.",
  {
    id: z.string().describe("The thought ID (returned when captured)")
  },
  async ({ id }) => {
    const db = getDatabase();

    console.error(`[mental-mcp] Getting thought: ${id}`);

    const items = await db.select()
      .from(mentalItems)
      .where(eq(mentalItems.id, id))
      .limit(1);

    if (items.length === 0) {
      return {
        content: [{
          type: "text",
          text: `Thought not found: ${id}`
        }]
      };
    }

    const item = items[0];
    const tags = JSON.parse(item.tags) as string[];

    return {
      content: [{
        type: "text",
        text: `# ${item.title}

**ID:** ${item.id}
**Status:** ${item.status}
**Theme:** ${item.theme || "none"}
**Tags:** ${tags.join(", ") || "none"}
**Created:** ${item.createdAt.toISOString()}
**Updated:** ${item.updatedAt.toISOString()}
${item.resolvedAt ? `**Resolved:** ${item.resolvedAt.toISOString()}` : ""}

## Content

${item.content}

${item.resolution ? `## Resolution\n\n${item.resolution}` : ""}`
      }]
    };
  }
);
```
  </action>
  <verify>pnpm --filter @mental/mcp-server build succeeds</verify>
  <done>get_thought tool retrieves full item details by ID</done>
</task>

<task type="auto">
  <name>Task 3: Verify full capture engine</name>
  <files>packages/mcp-server/src/index.ts</files>
  <action>
Final verification of all capture engine tools:

1. Build: pnpm --filter @mental/mcp-server build

2. Test with MCP Inspector:
   a. Call capture_thought with title, content, tags
   b. Note the returned ID
   c. Call list_thoughts - should show the item
   d. Call get_thought with the ID - should show full details

3. Verify no console.log:
   grep -r "console.log" packages/mcp-server/src/ should return nothing

4. Check database file exists:
   ls -la packages/mcp-server/mental.db

5. Verify tool count - should have 4 tools:
   - ping
   - capture_thought
   - list_thoughts
   - get_thought
  </action>
  <verify>All 4 tools work correctly; database persists; no console.log statements</verify>
  <done>Capture engine complete: capture, list, and get tools working with database persistence</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] pnpm -r build succeeds
- [ ] capture_thought → list_thoughts → get_thought workflow works
- [ ] Database file persists between MCP Inspector sessions
- [ ] No console.log statements
- [ ] 4 tools registered (ping, capture_thought, list_thoughts, get_thought)
</verification>

<success_criteria>
- list_thoughts returns captured items with status filter
- get_thought retrieves full item details
- All tools use console.error for logging
- Phase 3 complete - capture engine fully functional
</success_criteria>

<output>
After completion, create `.planning/phases/03-capture-engine/03-02-SUMMARY.md`
</output>
