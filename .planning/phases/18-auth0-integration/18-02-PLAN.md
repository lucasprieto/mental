---
phase: 18-auth0-integration
plan: 02
type: execute
depends_on: ["18-01"]
files_modified: [packages/webapp/package.json, packages/webapp/src/lib/auth0.ts, packages/webapp/middleware.ts, packages/webapp/.env.local.example]
---

<objective>
Integrate Auth0 into the webapp using nextjs-auth0 v4 with middleware pattern.

Purpose: Enable user authentication via Auth0 - login, logout, session management.
Output: Working Auth0 login flow, protected routes, session access in server components.
</objective>

<execution_context>
./.claude/get-shit-done/workflows/execute-plan.md
./.claude/get-shit-done/templates/summary.md
./.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/18-auth0-integration/18-RESEARCH.md
@.planning/phases/18-auth0-integration/18-01-SUMMARY.md

@packages/webapp/package.json
@packages/webapp/src/app/layout.tsx
@packages/webapp/src/app/page.tsx

**From RESEARCH.md:**
- Use @auth0/nextjs-auth0 v4 (NOT v3)
- v4 uses middleware.ts for auth routes (auto-mounted)
- Create Auth0Client instance in lib/auth0.ts
- getSession() for server components
- Middleware REQUIRED - handles /auth/* routes automatically

**Critical pitfalls to avoid:**
- DO NOT create /app/auth/[...auth0]/route.ts (v3 pattern, not v4)
- MUST have middleware.ts in project root (webapp/middleware.ts)
- Use `sub` claim as user ID, not email
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install nextjs-auth0 and create Auth0 client</name>
  <files>packages/webapp/package.json, packages/webapp/src/lib/auth0.ts, packages/webapp/.env.local.example</files>
  <action>
1. Install Auth0 SDK:
   pnpm --filter @mental/webapp add @auth0/nextjs-auth0

2. Create lib/auth0.ts:
```typescript
import { Auth0Client } from "@auth0/nextjs-auth0/server";

export const auth0 = new Auth0Client({
  domain: process.env.AUTH0_DOMAIN!,
  clientId: process.env.AUTH0_CLIENT_ID!,
  clientSecret: process.env.AUTH0_CLIENT_SECRET!,
  appBaseUrl: process.env.AUTH0_BASE_URL!,
  secret: process.env.AUTH0_SECRET!,
});
```

3. Create .env.local.example with required Auth0 vars:
```
# Auth0 Configuration
AUTH0_DOMAIN=your-tenant.auth0.com
AUTH0_CLIENT_ID=your-client-id
AUTH0_CLIENT_SECRET=your-client-secret
AUTH0_BASE_URL=http://localhost:3001
AUTH0_SECRET=a-long-random-secret-at-least-32-chars
```

Note: User will need to create Auth0 application and fill in real values.
  </action>
  <verify>pnpm --filter @mental/webapp build succeeds (will warn about missing env but compiles)</verify>
  <done>Auth0 SDK installed, client configured, env example created</done>
</task>

<task type="auto">
  <name>Task 2: Create Auth0 middleware for route protection</name>
  <files>packages/webapp/middleware.ts</files>
  <action>
Create middleware.ts in webapp package ROOT (packages/webapp/middleware.ts):

```typescript
import { auth0 } from "./src/lib/auth0";
import { NextRequest, NextResponse } from "next/server";

export async function middleware(request: NextRequest) {
  // Let Auth0 handle /auth/* routes
  const authRes = await auth0.middleware(request);

  if (request.nextUrl.pathname.startsWith("/auth")) {
    return authRes;
  }

  // For now, don't protect any routes - just pass through
  // Phase 19/20 will add protection after deployment
  return authRes;
}

export const config = {
  matcher: [
    // Match all routes except static files
    "/((?!_next/static|_next/image|favicon.ico).*)",
  ],
};
```

This enables:
- /auth/login - redirects to Auth0
- /auth/logout - clears session
- /auth/callback - handles OAuth redirect
- /auth/me - returns user info (API)

Routes are auto-mounted by auth0.middleware(), no route files needed.
  </action>
  <verify>pnpm --filter @mental/webapp dev starts, /auth/login redirects (will fail without real Auth0 config but route exists)</verify>
  <done>Auth0 middleware mounted, /auth/* routes functional</done>
</task>

<task type="auto">
  <name>Task 3: Add login/logout UI and session display</name>
  <files>packages/webapp/src/app/layout.tsx, packages/webapp/src/components/AuthButton.tsx</files>
  <action>
1. Create AuthButton.tsx component:
```typescript
import { auth0 } from "@/lib/auth0";

export async function AuthButton() {
  const session = await auth0.getSession();

  if (session) {
    return (
      <div className="flex items-center gap-4">
        <span className="text-sm text-gray-600">{session.user.email}</span>
        <a
          href="/auth/logout"
          className="text-sm text-blue-600 hover:underline"
        >
          Logout
        </a>
      </div>
    );
  }

  return (
    <a
      href="/auth/login"
      className="text-sm text-blue-600 hover:underline"
    >
      Login
    </a>
  );
}
```

2. Update layout.tsx to include AuthButton in header area.

Keep it simple - just show email and login/logout link. Full user management UI is Phase 20.
  </action>
  <verify>Webapp shows Login link when not authenticated, shows email + Logout when authenticated</verify>
  <done>Auth UI visible in webapp, login/logout flow works end-to-end</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `pnpm --filter @mental/webapp build` succeeds
- [ ] /auth/login route exists (middleware mounted)
- [ ] /auth/logout route exists
- [ ] AuthButton component renders correctly
- [ ] Layout includes auth UI
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- No TypeScript errors
- Auth0 integration ready (needs real Auth0 credentials to test fully)
- Login/logout UI visible in webapp
</success_criteria>

<output>
After completion, create `.planning/phases/18-auth0-integration/18-02-SUMMARY.md`
</output>
