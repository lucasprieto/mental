---
phase: 18-auth0-integration
plan: 03
type: execute
depends_on: ["18-01", "18-02"]
files_modified: [packages/api/src/middleware/jwt.ts, packages/api/src/index.ts, packages/api/.env.local.example]
---

<objective>
Add JWT validation middleware to API for webapp requests authenticated via Auth0.

Purpose: Secure API endpoints so webapp can make authenticated requests using Auth0 access tokens.
Output: API validates Auth0 JWTs, extracts user ID, ready for multi-user data access.
</objective>

<execution_context>
./.claude/get-shit-done/workflows/execute-plan.md
./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/18-auth0-integration/18-RESEARCH.md
@.planning/phases/18-auth0-integration/18-01-SUMMARY.md
@.planning/phases/18-auth0-integration/18-02-SUMMARY.md

@packages/api/src/index.ts
@packages/api/src/middleware/api-key.ts

**From RESEARCH.md:**
- Use Hono's built-in JWK middleware (hono/jwk)
- JWKS endpoint: https://{AUTH0_DOMAIN}/.well-known/jwks.json
- Extract user ID from `sub` claim in JWT payload
- JWK middleware handles JWKS fetching and caching automatically

**API authentication strategy:**
- Webapp requests: JWT (Authorization: Bearer {token})
- MCP requests: API Key (X-API-Key header)
- Create combined middleware that checks both
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create JWT validation middleware using Hono JWK</name>
  <files>packages/api/src/middleware/jwt.ts, packages/api/.env.local.example</files>
  <action>
1. Create jwt.ts middleware:
```typescript
import { jwk } from "hono/jwk";

// JWK middleware validates Auth0 access tokens
export const jwtAuth = jwk({
  jwks_uri: `https://${process.env.AUTH0_DOMAIN}/.well-known/jwks.json`,
});

// Helper to get user ID from JWT payload
export function getUserIdFromJwt(c: any): string | null {
  const payload = c.get("jwtPayload");
  return payload?.sub || null;
}
```

2. Update/create .env.local.example for API:
```
# Database
DATABASE_URL=postgresql://...

# Auth0 (for JWT validation)
AUTH0_DOMAIN=your-tenant.auth0.com
```

Note: JWK middleware automatically:
- Fetches JWKS from Auth0
- Caches keys
- Validates JWT signature
- Extracts payload to c.get("jwtPayload")
  </action>
  <verify>TypeScript compiles, middleware exports correctly</verify>
  <done>JWT middleware created using Hono JWK, validates Auth0 tokens</done>
</task>

<task type="auto">
  <name>Task 2: Create combined auth middleware for flexible authentication</name>
  <files>packages/api/src/middleware/auth.ts</files>
  <action>
Create auth.ts that combines both auth methods:

```typescript
import { createMiddleware } from "hono/factory";
import { createHash } from "crypto";
import { eq } from "drizzle-orm";
import { getDb } from "../db.js";
import { apiKeys } from "@mental/db";
import { jwtAuth, getUserIdFromJwt } from "./jwt.js";

/**
 * Combined auth middleware - accepts either:
 * 1. Authorization: Bearer {jwt} - for webapp (validated via JWKS)
 * 2. X-API-Key: {key} - for MCP server (validated via database)
 *
 * Sets c.set("userId") and c.set("authMethod") for downstream use.
 */
export const auth = createMiddleware(async (c, next) => {
  const authHeader = c.req.header("Authorization");
  const apiKey = c.req.header("X-API-Key");

  // Try JWT first (webapp)
  if (authHeader?.startsWith("Bearer ")) {
    try {
      // Run JWK middleware manually
      await jwtAuth(c, async () => {});
      const userId = getUserIdFromJwt(c);
      if (userId) {
        c.set("userId", userId);
        c.set("authMethod", "jwt");
        return next();
      }
    } catch {
      // JWT validation failed, try API key
    }
  }

  // Try API key (MCP server)
  if (apiKey) {
    const keyHash = createHash("sha256").update(apiKey).digest("hex");
    const db = getDb();

    const [record] = await db
      .select()
      .from(apiKeys)
      .where(eq(apiKeys.keyHash, keyHash))
      .limit(1);

    if (record) {
      // Update last used (fire and forget)
      db.update(apiKeys)
        .set({ lastUsedAt: new Date() })
        .where(eq(apiKeys.id, record.id))
        .execute();

      c.set("userId", record.userId);
      c.set("authMethod", "api_key");
      c.set("apiKeyId", record.id);
      return next();
    }
  }

  // No valid auth
  return c.json({ error: "Authentication required" }, 401);
});
```

This allows both webapp (JWT) and MCP (API key) to authenticate.
  </action>
  <verify>TypeScript compiles, middleware handles both auth methods</verify>
  <done>Combined auth middleware accepts JWT or API key, sets userId for both</done>
</task>

<task type="auto">
  <name>Task 3: Document authentication setup and update API structure</name>
  <files>packages/api/src/index.ts, packages/api/README.md</files>
  <action>
1. Update index.ts to show auth middleware usage pattern (don't apply globally yet):
```typescript
// Import auth middleware (not applied globally - routes opt-in)
// import { auth } from "./middleware/auth.js";
// Usage: app.use("/items/*", auth) when ready to protect routes
```

Add comment showing how routes will be protected in Phase 19/20.

2. Create/update packages/api/README.md documenting:
- Two authentication methods (JWT for webapp, API key for MCP)
- Required environment variables
- How to protect routes with auth middleware

Note: Don't actually protect routes yet - that breaks existing MCP integration.
Phase 19/20 will:
1. Run database migration to create tables
2. Create Auth0 users on first login
3. Enable route protection
4. Update MCP to use API keys
  </action>
  <verify>API starts without errors, README documents auth patterns</verify>
  <done>Auth infrastructure documented, ready to enable in Phase 19/20</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `pnpm --filter @mental/api build` succeeds
- [ ] JWT middleware validates against Auth0 JWKS endpoint pattern
- [ ] Combined auth middleware accepts both JWT and API key
- [ ] API still works without auth (not enforced yet)
- [ ] README documents authentication setup
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- No TypeScript errors
- Auth middleware ready to protect routes (will enable in Phase 19/20)
- Both JWT and API key authentication patterns implemented
- Phase 18 complete - all auth infrastructure in place
</success_criteria>

<output>
After completion, create `.planning/phases/18-auth0-integration/18-03-SUMMARY.md`
</output>
