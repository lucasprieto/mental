---
phase: 11-advanced-capture
plan: 02
type: execute
depends_on: ["11-01"]
files_modified: [packages/db/src/schema-pg.ts, packages/api/src/routes/items.ts, packages/mcp-server/src/index.ts]
---

<objective>
Add project context capture and auto-tagging based on detected sentiment.

Purpose: Enable thoughts to be associated with specific projects/repos and automatically tagged based on content analysis for easier filtering.
Output: Project field in schema/API, auto-tagging in MCP capture tool.
</objective>

<execution_context>
./.claude/get-shit-done/workflows/execute-plan.md
./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/11-advanced-capture/CONTEXT.md
@.planning/phases/11-advanced-capture/11-01-SUMMARY.md
@packages/db/src/schema-pg.ts
@packages/api/src/routes/items.ts
@packages/mcp-server/src/index.ts

**Tech stack available:** Drizzle ORM (Postgres), Hono, zod validation, MCP SDK
**Established patterns:** Schema fields as nullable text, API zod validators, detectSentiment() from Plan 01

**Requirements from CONTEXT.md:**
- Add `project` field for repo/project context
- Auto-apply tags based on sentiment:
  - blocker → ["blocker", "urgent"]
  - concern → ["concern", "risk"]
  - idea → ["idea", "enhancement"]
  - question → ["question", "clarification"]
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add project field to schema and API</name>
  <files>packages/db/src/schema-pg.ts, packages/api/src/routes/items.ts</files>
  <action>
1. In schema-pg.ts, add after sessionId:
```typescript
/** Project/repo name for context */
project: text("project"),
```

2. In items.ts POST route, add to zod validator:
```typescript
project: z.string().optional(),
```

3. In items.ts POST route, add to newItem:
```typescript
project: body.project ?? null,
```

4. In items.ts PUT route, add to zod validator:
```typescript
project: z.string().nullable().optional(),
```

5. In items.ts PUT route, add to updates handling:
```typescript
if (body.project !== undefined) updates.project = body.project;
```

6. Run `pnpm db:push` to sync schema to Neon database (from packages/db directory).
  </action>
  <verify>`pnpm db:push` succeeds, API accepts project field in POST/PUT</verify>
  <done>Project field added to schema and API, database migrated</done>
</task>

<task type="auto">
  <name>Task 2: Add auto-tag function based on sentiment</name>
  <files>packages/mcp-server/src/index.ts</files>
  <action>
Create `getAutoTags()` function that maps sentiment to tags:

```typescript
function getAutoTags(sentiment: "blocker" | "concern" | "idea" | "question" | null): string[] {
  switch (sentiment) {
    case "blocker": return ["blocker", "urgent"];
    case "concern": return ["concern", "risk"];
    case "idea": return ["idea", "enhancement"];
    case "question": return ["question", "clarification"];
    default: return [];
  }
}
```

Place this function after detectSentiment().
  </action>
  <verify>Function exists and returns correct tags for each sentiment</verify>
  <done>getAutoTags() function implemented with sentiment-to-tag mapping</done>
</task>

<task type="auto">
  <name>Task 3: Update capture_thought with project and auto-tags</name>
  <files>packages/mcp-server/src/index.ts</files>
  <action>
Update the capture_thought tool:

1. Add `project` parameter to zod schema:
```typescript
project: z.string().optional().describe("Project or repo name for context")
```

2. In the handler, merge auto-tags with user tags:
```typescript
const sentiment = detectSentiment(content);
const autoTags = getAutoTags(sentiment);
const allTags = [...new Set([...autoTags, ...(tags || [])])]; // dedupe
```

3. Update API call to include project:
```typescript
const res = await client.index.$post({
  json: {
    title,
    content,
    tags: allTags,  // Use merged tags
    theme: sentiment || theme ?? undefined,
    sessionId: currentSessionId ?? undefined,
    project: project ?? undefined,  // Add project
  }
});
```

4. Update logging:
```typescript
console.error(`[mental-mcp] Auto-tags: ${autoTags.join(", ") || "none"}`);
console.error(`[mental-mcp] Project: ${project || "none"}`);
```

5. Update response text to show project and auto-tags:
```
Project: ${project || "none"}
Auto-tags: ${autoTags.join(", ") || "none"}
```
  </action>
  <verify>Test capture_thought with project param and sentiment content - should show auto-tags</verify>
  <done>capture_thought accepts project, auto-generates tags from sentiment, includes both in API call</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `pnpm build` succeeds in all packages
- [ ] API test: POST /items with `project: "mental"` succeeds
- [ ] MCP test: capture_thought with blocker content shows auto-tags ["blocker", "urgent"]
- [ ] MCP test: capture_thought with project param stores project in item
- [ ] User-provided tags merge with auto-tags without duplicates
</verification>

<success_criteria>

- Project field in schema and API
- Auto-tagging based on sentiment working
- capture_thought accepts project parameter
- All builds pass
- Phase 11 complete
</success_criteria>

<output>
After completion, create `.planning/phases/11-advanced-capture/11-02-SUMMARY.md`
</output>
