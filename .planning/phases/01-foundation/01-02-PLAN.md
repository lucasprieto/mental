---
phase: 01-foundation
plan: 02
type: execute
depends_on: ["01-01"]
files_modified: [packages/db/package.json, packages/db/tsconfig.json, packages/db/src/schema.ts, packages/db/src/index.ts, packages/db/drizzle.config.ts]
---

<objective>
Set up SQLite database with Drizzle ORM and mental items schema.

Purpose: Provide persistent storage for mental items that both MCP server and webapp can use.
Output: Working database package with schema, migrations, and typed queries.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation/01-01-SUMMARY.md

**Stack decisions:**
- Database: SQLite (simple, local-first, no server)
- ORM: Drizzle (type-safe, great SQLite support)
- Location: packages/db (shared between MCP and webapp)

**MentalItem fields from shared types:**
- id, title, content, tags, theme, status, resolution, sessionId, createdAt, updatedAt, resolvedAt
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create database package with Drizzle</name>
  <files>packages/db/package.json, packages/db/tsconfig.json</files>
  <action>
    1. Create packages/db/ directory
    2. Create package.json with name "@mental/db"
    3. Add dependencies: drizzle-orm, better-sqlite3
    4. Add devDependencies: drizzle-kit, @types/better-sqlite3
    5. Add scripts:
       - "build": "tsc"
       - "db:generate": "drizzle-kit generate"
       - "db:migrate": "drizzle-kit migrate"
       - "db:studio": "drizzle-kit studio"
    6. Set main "dist/index.js", types "dist/index.d.ts"
    7. Create tsconfig.json extending root config
    8. Add @mental/shared as workspace dependency
  </action>
  <verify>cd packages/db && pnpm install succeeds</verify>
  <done>@mental/db package created with Drizzle dependencies</done>
</task>

<task type="auto">
  <name>Task 2: Create database schema</name>
  <files>packages/db/src/schema.ts, packages/db/drizzle.config.ts</files>
  <action>
    1. Create src/schema.ts with mentalItems table:
       - id: text primary key (use cuid2 for generation)
       - title: text not null
       - content: text not null
       - tags: text (JSON string array - SQLite doesn't have arrays)
       - theme: text (nullable)
       - status: text not null default 'open' (enum: open, resolved)
       - resolution: text (nullable)
       - sessionId: text (nullable)
       - createdAt: integer not null (Unix timestamp - SQLite best practice)
       - updatedAt: integer not null
       - resolvedAt: integer (nullable)
    2. Export the table and infer types using drizzle-orm
    3. Create drizzle.config.ts:
       - schema: "./src/schema.ts"
       - out: "./drizzle"
       - driver: "better-sqlite3"
       - dbCredentials: { url: "./mental.db" }
  </action>
  <verify>cd packages/db && pnpm db:generate creates migration files in drizzle/</verify>
  <done>Schema defined, migration generated</done>
</task>

<task type="auto">
  <name>Task 3: Create database client and exports</name>
  <files>packages/db/src/index.ts, packages/db/src/client.ts</files>
  <action>
    1. Create src/client.ts:
       - Import Database from better-sqlite3
       - Import drizzle from drizzle-orm/better-sqlite3
       - Create and export getDb function that:
         - Takes optional dbPath (defaults to ./mental.db)
         - Creates better-sqlite3 instance
         - Wraps with drizzle
         - Returns typed db client
    2. Create src/index.ts that exports:
       - Schema (mentalItems table)
       - Client (getDb function)
       - Types inferred from schema
    3. Run pnpm build to compile
  </action>
  <verify>cd packages/db && pnpm build succeeds, dist/ contains compiled files</verify>
  <done>@mental/db exports schema, client, and types</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `pnpm -r build` succeeds (all packages build)
- [ ] packages/db/drizzle/ contains migration files
- [ ] @mental/db exports getDb function and schema
- [ ] TypeScript types are inferred from schema
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- Database package ready for use by MCP server and webapp
- Phase 1 complete
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-02-SUMMARY.md`
</output>
