---
phase: 10-webapp-sync
plan: 01
type: execute
depends_on: []
files_modified: [packages/webapp/src/lib/api.ts, packages/webapp/src/app/page.tsx, packages/webapp/src/app/item/[id]/page.tsx, packages/webapp/src/app/api/items/route.ts, packages/webapp/src/app/api/items/[id]/route.ts, packages/webapp/package.json]
---

<objective>
Convert webapp from local SQLite to remote API calls.

Purpose: Enable multi-computer access by syncing webapp with hosted Neon database via API.
Output: Webapp fetches and mutates data via remote API instead of local SQLite.
</objective>

<execution_context>
./.claude/get-shit-done/workflows/execute-plan.md
./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/09-mcp-server-sync/09-01-SUMMARY.md

**Established pattern from Phase 9:**
- Use separate route clients (`getItemsClient()`) not single `AppType` due to Hono routing type inference
- Use `hc<ItemsRoute>()` from `hono/client`
- Lazy initialization with logging
- Import types from `@mental/api`

**Files to modify:**
@packages/webapp/src/lib/db.ts - Will be replaced with api.ts
@packages/webapp/src/app/page.tsx - Uses direct Drizzle queries
@packages/webapp/src/app/item/[id]/page.tsx - Uses direct Drizzle queries
@packages/webapp/src/app/api/items/route.ts - Uses local SQLite for POST
@packages/webapp/src/app/api/items/[id]/route.ts - Uses local SQLite for PUT

**API endpoints available (from packages/api/src/routes/items.ts):**
- GET /items?status=open|resolved|all&limit=N&tags=tag1,tag2 - List items
- GET /items/:id - Get single item
- POST /items - Create item (body: {title, content, tags?, theme?, sessionId?})
- PUT /items/:id - Update item (body: {title?, content?, tags?, theme?, status?, resolution?})
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create API client module and update dependencies</name>
  <files>packages/webapp/src/lib/api.ts, packages/webapp/package.json</files>
  <action>
1. Add `@mental/api` and `hono` to webapp dependencies in package.json (copy pattern from packages/mcp-server/package.json)

2. Create `packages/webapp/src/lib/api.ts` following MCP server pattern:
   - Import `hc` from "hono/client"
   - Import `ItemsRoute` from "@mental/api"
   - Use env var `MENTAL_API_URL` with fallback to "http://localhost:3000"
   - Create lazy-initialized `getItemsClient()` returning `hc<ItemsRoute>(...)`
   - Add console.log for API connection (use console.log not console.error since this is webapp)

3. Run `pnpm install` from root to link dependencies
  </action>
  <verify>TypeScript compiles: `cd packages/webapp && pnpm exec tsc --noEmit`</verify>
  <done>api.ts exists with getItemsClient(), dependencies installed, types resolve</done>
</task>

<task type="auto">
  <name>Task 2: Convert dashboard and detail pages to use API</name>
  <files>packages/webapp/src/app/page.tsx, packages/webapp/src/app/item/[id]/page.tsx</files>
  <action>
1. Update `packages/webapp/src/app/page.tsx`:
   - Replace `import { getDatabase }` with `import { getItemsClient }` from "@/lib/api"
   - Remove `@mental/db` imports (mentalItems, desc, eq)
   - Replace direct Drizzle queries with API calls:
     - `const client = getItemsClient()`
     - For all items: `const res = await client.index.$get({ query: { status: "all", limit: "100" } }); const allItems = await res.json()`
     - For open items: filter client-side from allItems where status === "open"
     - For resolved items: filter client-side from allItems where status === "resolved", slice to 10
   - Keep all filtering logic (tags, theme) - it works on the items array
   - Keep stats calculation and display unchanged

2. Update `packages/webapp/src/app/item/[id]/page.tsx`:
   - Replace `import { getDatabase }` with `import { getItemsClient }` from "@/lib/api"
   - Remove `@mental/db` imports
   - Replace query with: `const client = getItemsClient(); const res = await client[":id"].$get({ param: { id } }); if (!res.ok) notFound(); const item = await res.json()`
   - Keep notFound() call for 404 case
   - Keep ItemDetailClient render unchanged
  </action>
  <verify>
    Run `pnpm build` from packages/webapp - should compile without errors.
    Start API server and webapp, visit dashboard - should load items from remote.
  </verify>
  <done>Dashboard and detail pages fetch from API, no direct database imports remain in page components</done>
</task>

<task type="auto">
  <name>Task 3: Convert webapp API routes to proxy to remote API</name>
  <files>packages/webapp/src/app/api/items/route.ts, packages/webapp/src/app/api/items/[id]/route.ts, packages/webapp/src/lib/db.ts</files>
  <action>
1. Update `packages/webapp/src/app/api/items/route.ts` (POST handler):
   - Replace local DB operations with API call
   - Import `getItemsClient` from "@/lib/api"
   - Use: `const client = getItemsClient(); const res = await client.index.$post({ json: { title, content, tags: tagsArray, theme } })`
   - Return response from API directly: `return NextResponse.json(await res.json(), { status: res.status })`
   - Keep validation logic (title required, content required)

2. Update `packages/webapp/src/app/api/items/[id]/route.ts` (PUT handler):
   - Replace local DB operations with API call
   - Import `getItemsClient` from "@/lib/api"
   - Use: `const client = getItemsClient(); const res = await client[":id"].$put({ param: { id }, json: updates })`
   - Return response from API directly
   - Simplify validation - let API handle it

3. Delete `packages/webapp/src/lib/db.ts` (no longer needed)

4. Remove `@mental/db` from webapp package.json dependencies since it's no longer used
  </action>
  <verify>
    Test POST: `curl -X POST http://localhost:3001/api/items -H "Content-Type: application/json" -d '{"title":"Test","content":"Test content"}'` returns 201 with item
    Test PUT: Use returned ID to update via PUT
    Confirm db.ts deleted and @mental/db removed from package.json
  </verify>
  <done>API routes proxy to remote API, local db.ts deleted, @mental/db removed from dependencies</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `pnpm build` succeeds in packages/webapp
- [ ] Dashboard loads items from remote API (check network tab or API server logs)
- [ ] Item detail page loads single item from remote API
- [ ] Creating item via webapp calls remote API
- [ ] Editing item via webapp calls remote API
- [ ] No references to @mental/db remain in webapp package
- [ ] db.ts deleted from webapp
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- Webapp uses remote API for all data operations
- No local SQLite dependencies in webapp
- Phase 10 complete
</success_criteria>

<output>
After completion, create `.planning/phases/10-webapp-sync/10-01-SUMMARY.md` with:
- Duration and task count
- Files modified/deleted
- Any deviations from plan
- Issues encountered
- Confirmation that webapp now uses remote API
</output>
