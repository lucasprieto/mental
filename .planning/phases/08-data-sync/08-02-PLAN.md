---
phase: 08-data-sync
plan: 02
type: execute
depends_on: ["08-01"]
files_modified: [packages/api/scripts/migrate-from-sqlite.ts, packages/api/package.json]
---

<objective>
Migrate existing SQLite data to Neon Postgres.

Purpose: Transfer all captured thoughts from local database to hosted database.
Output: All existing items migrated with preserved IDs, verified data integrity.
</objective>

<execution_context>
./.claude/get-shit-done/workflows/execute-plan.md
./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-data-sync/08-RESEARCH.md
@.planning/phases/08-data-sync/08-01-SUMMARY.md
@packages/db/src/schema.ts
@packages/db/src/schema-pg.ts
@packages/api/src/db.ts
@packages/mcp-server/mental.db (SQLite source)

**Tech stack available:** better-sqlite3, drizzle-orm, @neondatabase/serverless
**Key pattern:** Timestamp conversion - SQLite uses integer (unix seconds), Postgres uses native timestamp
**Constraining decisions:**
- Direct insert to Neon to preserve existing cuid2 IDs
- Migrate all items (open and resolved) for complete history
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create migration script that preserves IDs</name>
  <files>packages/api/scripts/migrate-from-sqlite.ts, packages/api/package.json</files>
  <action>
    Create packages/api/scripts/migrate-from-sqlite.ts that:

    1. Reads all items from local SQLite (packages/mcp-server/mental.db)
    2. Converts timestamps: `new Date(unix_timestamp * 1000)` for created_at, updated_at, resolved_at
    3. Inserts directly into Neon using drizzle (NOT via API) to preserve original IDs
    4. Handles the tags field (already stored as JSON string)
    5. Reports count of migrated items

    Use better-sqlite3 for reading SQLite, getDbPg() for writing to Neon.

    Add script to package.json: "migrate": "tsx scripts/migrate-from-sqlite.ts"

    Add tsx as devDependency if not present.

    Note: Must load .env.local before running (use dotenv or pass DATABASE_URL inline).
  </action>
  <verify>cat packages/api/scripts/migrate-from-sqlite.ts shows complete migration script</verify>
  <done>Migration script created with timestamp conversion and ID preservation</done>
</task>

<task type="auto">
  <name>Task 2: Run migration and verify data integrity</name>
  <files>-</files>
  <action>
    Run the migration script:
    ```
    cd packages/api && pnpm migrate
    ```

    Verify migration succeeded by:
    1. Starting the API: `pnpm --filter @mental/api dev` (or build + node)
    2. Fetching items via API: `curl http://localhost:3000/items`
    3. Comparing count to source: should match SQLite item count
    4. Spot-check a few items for correct dates and content

    If migration fails, debug and re-run (script should be idempotent or handle duplicates).
  </action>
  <verify>curl localhost:3000/items returns array with same count as SQLite, dates are correct (not 1970)</verify>
  <done>All items migrated, data integrity verified, API serves data from Neon</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Migration script exists and runs without errors
- [ ] All items from SQLite appear in Neon
- [ ] Timestamps are correct (not showing 1970 dates)
- [ ] Item IDs match original SQLite IDs
- [ ] API CRUD operations work with migrated data
</verification>

<success_criteria>

- All tasks completed
- Data fully migrated from SQLite to Neon
- No data loss or corruption
- Phase 8 complete, ready for Phase 9 (MCP Server Sync)
</success_criteria>

<output>
After completion, create `.planning/phases/08-data-sync/08-02-SUMMARY.md`
</output>
